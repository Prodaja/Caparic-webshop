<!doctype html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Caparicki webshop</title>
  <meta name="description" content="Caparicki webshop – moderan mini webshop za decu (squishy)." />

  <style>
    :root{
      --bg0:#060817;
      --bg1:#0b1130;
      --card: rgba(255,255,255,.085);
      --card2: rgba(255,255,255,.12);
      --stroke: rgba(255,255,255,.14);
      --text:#f3f5ff;
      --muted: rgba(243,245,255,.78);
      --shadow: 0 18px 55px rgba(0,0,0,.45);

      --p1:#7c5cff;   /* purple */
      --p2:#34d399;   /* green */
      --p3:#ff6bd6;   /* pink */
      --p4:#ffd166;   /* yellow */
      --p5:#4dd3ff;   /* cyan */
      --radius: 22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 900px at 10% -10%, rgba(124,92,255,.35), transparent 60%),
        radial-gradient(900px 650px at 90% 0%, rgba(52,211,153,.25), transparent 60%),
        radial-gradient(900px 650px at 50% 120%, rgba(255,107,214,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* floating blobs for subtle motion */
    .blob{
      position:fixed; z-index:-1; filter: blur(18px);
      opacity:.65; border-radius: 999px;
      animation: floaty 10s ease-in-out infinite;
    }
    .b1{ width:320px;height:320px; left:-80px; top:120px; background: rgba(255,107,214,.35); animation-duration: 11s;}
    .b2{ width:360px;height:360px; right:-120px; top:180px; background: rgba(77,211,255,.30); animation-duration: 13s;}
    .b3{ width:420px;height:420px; left:35%; bottom:-200px; background: rgba(52,211,153,.25); animation-duration: 15s;}
    @keyframes floaty{
      0%,100%{ transform: translateY(0) translateX(0) scale(1); }
      50%{ transform: translateY(-18px) translateX(14px) scale(1.05); }
    }

    .wrap{max-width:1180px;margin:0 auto;padding:18px 16px 34px;}

    /* Topbar */
    .topbar{
      position:sticky; top:12px; z-index:30;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px;
      border-radius: 26px;
      background: rgba(12,16,44,.62);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      box-shadow: 0 10px 30px rgba(0,0,0,.28);
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{
      width:44px;height:44px;border-radius:16px; position:relative; flex:0 0 auto;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.75), transparent 42%),
        conic-gradient(from 210deg, var(--p1), var(--p2), var(--p3), var(--p5), var(--p1));
      box-shadow: 0 18px 44px rgba(124,92,255,.35);
    }
    .logo:after{
      content:""; position:absolute; inset:11px;
      border-radius:12px; background: rgba(6,8,23,.55);
      border:1px solid rgba(255,255,255,.12);
    }
    .brand h1{margin:0;font-size:15px;font-weight:1000;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brand small{display:block;margin-top:2px;color:var(--muted);font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-weight:950;
      user-select:none;
    }
    .count{
      padding:2px 10px;border-radius:999px;
      background: rgba(124,92,255,.25);
      border:1px solid rgba(124,92,255,.55);
    }
    .btn{
      border:0; cursor:pointer; user-select:none;
      padding:10px 12px;border-radius:16px;
      font-weight:1000;
      color:#08102a;
      background: linear-gradient(135deg, var(--p2), #a6ffd8);
      box-shadow: 0 16px 44px rgba(52,211,153,.18);
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:hover{transform: translateY(-1px); filter: brightness(1.03)}
    .btn.secondary{
      color: var(--text);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
    }

    /* Portal hero */
    .hero{
      margin-top:14px;
      border-radius: 32px;
      padding:18px;
      background:
        radial-gradient(900px 380px at 15% 20%, rgba(124,92,255,.22), transparent 60%),
        radial-gradient(900px 380px at 85% 30%, rgba(52,211,153,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .heroGrid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .heroGrid{grid-template-columns:1fr}
    }
    .hero h2{
      margin:0 0 8px 0;
      font-size: 32px;
      line-height:1.05;
      letter-spacing:.2px;
      font-weight:1150;
    }
    .hero p{
      margin:0;
      color: var(--muted);
      font-weight:800;
      line-height:1.45;
      font-size: 14.5px;
    }
    .badges{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:1000;
      font-size: 12px;
    }
    .dot{width:10px;height:10px;border-radius:50%;}
    .d1{background: var(--p4); box-shadow:0 0 0 6px rgba(255,209,102,.12)}
    .d2{background: var(--p3); box-shadow:0 0 0 6px rgba(255,107,214,.12)}
    .d3{background: var(--p2); box-shadow:0 0 0 6px rgba(52,211,153,.12)}

    /* Featured row (portal-style) */
    .featuredWrap{
      border-radius: 26px;
      background: rgba(12,16,44,.55);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      position:relative;
    }
    .featuredHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-weight:1100;
    }
    .featuredRow{
      display:flex; gap:12px;
      padding:12px;
      overflow:auto;
      scroll-snap-type:x mandatory;
    }
    .featuredRow::-webkit-scrollbar{height:10px}
    .featuredRow::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}
    .feat{
      scroll-snap-align:start;
      min-width: 240px;
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease;
    }
    .feat:hover{transform: translateY(-2px); border-color: rgba(124,92,255,.42)}
    .featImg{
      height:110px;
      background: linear-gradient(135deg, rgba(124,92,255,.28), rgba(52,211,153,.22));
      display:flex;align-items:center;justify-content:center;
      position:relative;
    }
    .featImg img{width:100%;height:100%;object-fit:cover;display:block}
    .featC{padding:10px}
    .featName{font-weight:1100;font-size:13px;margin:0}
    .featPrice{color:var(--muted);font-weight:1000;font-size:12px;margin-top:6px}

    /* Controls */
    .controls{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.3fr 1fr auto;
      gap:10px;
    }
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      font-weight:900;
    }
    input::placeholder{color: rgba(243,245,255,.70); font-weight:800}
    @media (max-width: 900px){ .controls{grid-template-columns:1fr 1fr} }
    @media (max-width: 520px){ .controls{grid-template-columns:1fr} }

    /* Product grid */
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, 1fr)} }
    @media (max-width: 520px){ .grid{grid-template-columns: 1fr} }

    .card{
      border-radius: var(--radius);
      overflow:hidden;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
      transition: transform .12s ease, border-color .12s ease;
      position:relative;
    }
    .card:hover{transform: translateY(-2px); border-color: rgba(124,92,255,.42)}

    .img{
      height: 170px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), transparent 45%),
        linear-gradient(135deg, rgba(124,92,255,.28), rgba(52,211,153,.22));
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .img img{width:100%;height:100%;object-fit:cover;display:block;filter:saturate(1.05) contrast(1.02)}
    .ph{
      padding:8px 10px;border-radius:999px;
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(255,255,255,.9);
      color: rgba(6,8,23,.92);
      font-weight:1100;
      letter-spacing:.3px;
    }

    .badgeCorner{
      position:absolute; top:10px; left:10px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(6,8,23,.35);
      backdrop-filter: blur(8px);
      font-weight:1100;
      font-size: 11px;
    }

    .heart{
      position:absolute; top:10px; right:10px;
      width:38px;height:38px;border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(6,8,23,.35);
      backdrop-filter: blur(8px);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      user-select:none;
    }
    .heart:hover{transform: translateY(-1px); border-color: rgba(255,107,214,.55)}
    .heart.active{background: rgba(255,107,214,.22); border-color: rgba(255,107,214,.65)}
    .heart svg{width:18px;height:18px;fill:none;stroke:rgba(243,245,255,.9);stroke-width:2}
    .heart.active svg{fill:rgba(255,107,214,.9);stroke:rgba(255,107,214,.9)}

    .c{padding:12px}
    .row2{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .name{margin:0; font-size:14px; font-weight:1100; line-height:1.15}
    .tag{
      font-size:11px; font-weight:1100;
      padding:6px 8px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color: var(--muted);
      white-space:nowrap;
    }
    .desc{margin:8px 0 10px 0; color: var(--muted); font-weight:850; font-size:12.5px; line-height:1.35; min-height:34px}
    .price{font-weight:1200; font-size:15px}
    .actions{display:flex; gap:10px; margin-top:10px}
    .add{
      flex:1;
      border:0; cursor:pointer;
      padding:10px 12px;border-radius:16px;
      font-weight:1200;
      color:#070a16;
      background: linear-gradient(135deg, var(--p1), var(--p3));
      box-shadow: 0 16px 40px rgba(124,92,255,.16);
      transition: transform .12s ease, filter .12s ease;
    }
    .add:hover{transform: translateY(-1px); filter: brightness(1.03)}
    .details{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;border-radius:16px;
      cursor:pointer;
      font-weight:1100;
    }

    /* Drawer cart */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index:50;
    }
    .drawer{
      position:fixed; top:0; right:0; height:100%;
      width:min(420px, 92vw);
      background: rgba(10,14,34,.96);
      border-left:1px solid rgba(255,255,255,.14);
      box-shadow: -18px 0 60px rgba(0,0,0,.35);
      transform: translateX(105%);
      transition: transform .18s ease;
      z-index:60;
      display:flex; flex-direction:column;
    }
    .drawer.open{transform: translateX(0)}
    .dhead{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
    }
    .x{
      width:38px;height:38px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:1100;
    }
    .items{padding:12px; overflow:auto; flex:1}
    .item{
      display:grid; grid-template-columns: 54px 1fr auto;
      gap:10px; align-items:center;
      padding:10px; border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      margin-bottom:10px;
    }
    .mini{
      width:54px;height:54px;border-radius:16px; overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      font-weight:1100; color: rgba(243,245,255,.80);
    }
    .mini img{width:100%;height:100%;object-fit:cover;display:block}
    .ititle{font-weight:1100; font-size:13px; margin:0 0 4px 0}
    .iprice{color: var(--muted); font-weight:950; font-size:12px}
    .qty{display:flex; align-items:center; gap:8px; justify-content:flex-end}
    .qbtn{
      width:32px;height:32px;border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:1200;
    }
    .sum{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
    }
    .sumrow{display:flex; justify-content:space-between; align-items:center; margin:8px 0}
    .sumrow span{color: var(--muted); font-weight:1100}
    .checkout{
      width:100%;
      border:0; cursor:pointer;
      padding:12px 14px;border-radius:18px;
      font-weight:1200;
      color:#070a16;
      background: linear-gradient(135deg, var(--p2), #a6ffd8);
      margin-top:10px;
    }
    .note{margin:10px 0 0; color: rgba(243,245,255,.75); font-weight:850; font-size:12px; line-height:1.35}

    /* Modal */
    .modalbg{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:70;
    }
    .modal{
      width:min(900px, 100%);
      border-radius: 26px;
      background: rgba(10,14,34,.96);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .mhead{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
    }
    .mbody{
      display:grid; grid-template-columns: 1.1fr .9fr;
      gap:14px; padding:14px;
    }
    @media (max-width: 820px){ .mbody{grid-template-columns:1fr} }
    .mimg{
      height:320px;
      border-radius: 22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
    }
    .mimg img{width:100%;height:100%;object-fit:cover;display:block}
    .minfo{
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      padding:12px;
    }
    .minfo h3{margin:0 0 6px 0; font-weight:1200}
    .meta{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 10px 0}
    .pill{
      font-size:11px; font-weight:1100;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--muted);
    }

    /* Confetti */
    .confetti{
      position:fixed; inset:0; pointer-events:none; z-index:80;
      overflow:hidden; display:none;
    }
    .confetti i{
      position:absolute; width:10px; height:14px; border-radius:4px;
      opacity:.95;
      animation: fall 900ms linear forwards;
      transform: translateY(-20px) rotate(0deg);
    }
    @keyframes fall{
      to{ transform: translateY(110vh) rotate(420deg) scale(1); opacity:1; }
    }

    .footer{
      margin:18px 0 6px;
      text-align:center;
      color: rgba(243,245,255,.70);
      font-weight:850;
      font-size:12px;
    }

    @media (prefers-reduced-motion: reduce){
      .blob{animation:none}
      .card:hover,.btn:hover,.add:hover,.feat:hover{transform:none}
    }
  </style>
</head>

<body>
  <div class="blob b1"></div>
  <div class="blob b2"></div>
  <div class="blob b3"></div>

  <div class="wrap">
    <header class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div style="min-width:0">
          <h1 id="shopName">Caparicki webshop</h1>
          <small id="shopSub">Squishy portal • Izaberi i poruči</small>
        </div>
      </div>

      <div class="right">
        <div class="chip" title="Broj proizvoda u korpi">
          Korpa <span class="count" id="cartCount">0</span>
        </div>
        <div class="chip" title="Wishlist">
          ❤️ <span class="count" id="wishCount">0</span>
        </div>
        <button class="btn secondary" id="openCart">Otvori korpu</button>
      </div>
    </header>

    <section class="hero">
      <div class="heroGrid">
        <div>
          <h2>Caparicki Webshop Portal</h2>
          <p>
            Izaberi omiljene squishy proizvode, stavi u wishlist ili u korpu i pošalji porudžbinu roditelju.
            Sve radi na telefonu i izgleda kao pravi webshop.
          </p>

          <div class="badges">
            <span class="badge"><span class="dot d1"></span> Novi drop</span>
            <span class="badge"><span class="dot d2"></span> Trending</span>
            <span class="badge"><span class="dot d3"></span> Mobile-friendly</span>
          </div>

          <div class="controls">
            <input id="q" placeholder="Pretraga (npr. kapibara, donut, boba)" />
            <select id="sort">
              <option value="popular">Sort: preporučeno</option>
              <option value="cheap">Cena: niža → viša</option>
              <option value="expensive">Cena: viša → niža</option>
              <option value="name">Naziv: A → Z</option>
            </select>
            <button class="btn" id="scrollShop">Ponuda</button>
          </div>

          <p class="note" id="eduNote">
            Tip: Klikni ❤️ da sačuvaš favorit. Kad završiš, otvori korpu i pošalji porudžbinu.
          </p>
        </div>

        <div class="featuredWrap">
          <div class="featuredHead">
            <span>Featured / Novi drop</span>
            <span style="color:var(--muted);font-weight:1000;font-size:12px">prevuci levo-desno</span>
          </div>
          <div class="featuredRow" id="featuredRow"></div>
        </div>
      </div>
    </section>

    <div class="grid" id="grid"></div>

    <div class="footer">
      © <span id="year"></span> Caparicki webshop • demo porudžbina (bez pravog plaćanja)
    </div>
  </div>

  <div class="confetti" id="confetti"></div>

  <!-- Cart drawer -->
  <div class="backdrop" id="backdrop"></div>
  <aside class="drawer" id="drawer" aria-label="Korpa">
    <div class="dhead">
      <b>Moja korpa</b>
      <button class="x" id="closeCart" aria-label="Zatvori">X</button>
    </div>

    <div class="items" id="cartItems"></div>

    <div class="sum">
      <div class="sumrow">
        <span>Ukupno</span>
        <b id="total">0 RSD</b>
      </div>
      <button class="checkout" id="checkoutBtn">Pošalji roditelju (Viber)</button>
      <p class="note">
        Poruka sadrži listu proizvoda i ukupnu cenu. (Nema kartica i nema plaćanja na sajtu.)
      </p>
    </div>
  </aside>

  <!-- Modal -->
  <div class="modalbg" id="modalBg" aria-label="Detalji proizvoda">
    <div class="modal">
      <div class="mhead">
        <b>Brzi pregled</b>
        <button class="x" id="closeModal" aria-label="Zatvori">X</button>
      </div>
      <div class="mbody">
        <div class="mimg" id="mimg"></div>
        <div class="minfo">
          <h3 id="mname">—</h3>
          <div class="meta" id="mmeta"></div>
          <p id="mdesc" style="margin:0;color:var(--muted);font-weight:900;line-height:1.45"></p>
          <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;">
            <button class="btn" id="madd">Dodaj u korpu</button>
            <button class="btn secondary" id="mwish">❤️ Wishlist</button>
            <button class="btn secondary" id="mclose2">Zatvori</button>
          </div>
          <p class="note" style="margin-top:10px;">
            Savet: Favorit (❤️) služi da kasnije lakše odlučiš šta stvarno želiš.
          </p>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   1) TI MENJAŠ OVO
   ========================= */
const SHOP_NAME = "Caparicki webshop";
const SHOP_SUB  = "Squishy portal • Izaberi i poruči";
const CURRENCY  = "RSD";

/* Slike ubaci u folder img/ (pored index.html), pa u img upiši npr: "img/kapibara.jpg" */
const PRODUCTS = [
  { id:"kapibara", name:"Mini Squishy", price: 790,  tag:"Hit",  img:"img/kapibara.jpg", desc:"Mekana kapibara – savršena za stiskanje i opuštanje." },
  { id:"donut",    name:"Galaxy Squishy",  price: 990,  tag:"Wow",  img:"img/donut.jpg",    desc:"Šareni Squishy koji izgleda kao iz svemira." },
  { id:"boba",     name:"Squishy Mellow", price: 185, tag:"Top",  img:"img/boba.jpg",     desc:"Ovo je tako — preslatko i cool." },
  { id:"panda",    name:"Narukvice 30 Kom.",    price: 850,  tag:"Kul",  img:"img/panda.jpg",    desc:"Najbolje narukvice za tebe i tvoju porodicu" },
  { id:"cake",     name:"Tortica fenomenalno",price: 1290, tag:"Slatko",img:"img/cake.jpg",     desc:"wow efekat za vitrinu." },
  { id:"rainbow",  name:"Vrh Squishy", price: 1390, tag:"Šareno",img:"img/rainbow.jpg",  desc:" Kad je vidiš, moraš je imati." }
];

/* =========================
   2) LOGIKA (NE DIRAJ)
   ========================= */
const fmt = new Intl.NumberFormat("sr-RS", { style:"currency", currency: CURRENCY, maximumFractionDigits: 0 });

const EDU_TIPS = [
  "Tip: Klikni ❤️ da sačuvaš favorit. Posle izaberi 1–2 najbolja.",
  "Tip: Uporedi 2 proizvoda — cena, izgled, i koji ti je stvarno najbolji.",
  "Tip: Ukupno = cena × količina. (Pravi webshop račun.)",
  "Tip: Dodaj u korpu samo ono što želiš da poručiš roditelju."
];

const state = { q:"", sort:"popular", cart: load("cap_cart", {}), wish: load("cap_wish", {}) };

function load(key, def){
  try{
    const raw = localStorage.getItem(key);
    if(raw===null) return def;
    return JSON.parse(raw);
  }catch(e){ return def; }
}
function save(){
  localStorage.setItem("cap_cart", JSON.stringify(state.cart));
  localStorage.setItem("cap_wish", JSON.stringify(state.wish));
  updateCounts();
}

function updateCounts(){
  const cartCount = Object.values(state.cart).reduce((a,b)=>a+b,0);
  const wishCount = Object.keys(state.wish).length;
  document.getElementById("cartCount").textContent = cartCount;
  document.getElementById("wishCount").textContent = wishCount;
}

function filtered(){
  let list = PRODUCTS.slice();
  const s = state.q.trim().toLowerCase();
  if(s){
    list = list.filter(p =>
      p.name.toLowerCase().includes(s) ||
      (p.desc||"").toLowerCase().includes(s) ||
      (p.tag||"").toLowerCase().includes(s)
    );
  }
  if(state.sort === "cheap") list.sort((a,b)=>a.price-b.price);
  if(state.sort === "expensive") list.sort((a,b)=>b.price-a.price);
  if(state.sort === "name") list.sort((a,b)=>a.name.localeCompare(b.name,"sr"));
  return list;
}

function heartSvg(){
  return `
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 21s-7-4.4-9.3-8.7C.9 8.8 3 5.7 6.3 5.4c1.8-.2 3.4.7 4.4 2
               1-1.3 2.6-2.2 4.4-2 3.3.3 5.4 3.4 3.6 6.9C19 16.6 12 21 12 21z"/>
    </svg>`;
}

function renderFeatured(){
  const row = document.getElementById("featuredRow");
  row.innerHTML = "";
  const picks = PRODUCTS.slice(0, 6);
  picks.forEach(p=>{
    const el = document.createElement("div");
    el.className = "feat";
    el.onclick = ()=> openModal(p.id);

    const img = document.createElement("div");
    img.className = "featImg";
    if(p.img){
      const im = document.createElement("img");
      im.src = p.img; im.alt = p.name;
      img.appendChild(im);
    } else {
      const ph = document.createElement("div");
      ph.className="ph"; ph.textContent="UBACI SLIKU";
      img.appendChild(ph);
    }

    const c = document.createElement("div");
    c.className="featC";
    c.innerHTML = `<div class="featName">${escapeHtml(p.name)}</div>
                   <div class="featPrice">${escapeHtml(p.tag||"Featured")} • ${fmt.format(p.price)}</div>`;
    el.appendChild(img);
    el.appendChild(c);
    row.appendChild(el);
  });
}

function renderGrid(){
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  const list = filtered();

  if(!list.length){
    const div = document.createElement("div");
    div.style.gridColumn="1/-1";
    div.style.padding="16px";
    div.style.border="1px solid rgba(255,255,255,.14)";
    div.style.borderRadius="22px";
    div.style.background="rgba(255,255,255,.05)";
    div.style.color="rgba(243,245,255,.85)";
    div.style.fontWeight="950";
    div.textContent="Nema rezultata. Probaj drugu pretragu.";
    grid.appendChild(div);
    return;
  }

  list.forEach(p=>{
    const card = document.createElement("div");
    card.className="card";

    const img = document.createElement("div");
    img.className="img";

    const corner = document.createElement("div");
    corner.className="badgeCorner";
    corner.textContent = p.tag || "Squishy";
    img.appendChild(corner);

    const heart = document.createElement("div");
    heart.className = "heart" + (state.wish[p.id] ? " active" : "");
    heart.innerHTML = heartSvg();
    heart.title = state.wish[p.id] ? "Ukloni iz wishlist" : "Dodaj u wishlist";
    heart.onclick = (e)=>{ e.stopPropagation(); toggleWish(p.id); };
    img.appendChild(heart);

    if(p.img){
      const im = document.createElement("img");
      im.src = p.img; im.alt = p.name;
      img.appendChild(im);
    } else {
      const ph = document.createElement("div");
      ph.className="ph";
      ph.textContent="UBACI SLIKU";
      img.appendChild(ph);
    }

    const c = document.createElement("div");
    c.className="c";

    const row = document.createElement("div");
    row.className="row2";

    const name = document.createElement("h3");
    name.className="name";
    name.textContent = p.name;

    const tag = document.createElement("div");
    tag.className="tag";
    tag.textContent = "RSD";

    row.appendChild(name);
    row.appendChild(tag);

    const desc = document.createElement("div");
    desc.className="desc";
    desc.textContent = (p.desc||"");

    const price = document.createElement("div");
    price.className="price";
    price.textContent = fmt.format(p.price);

    const actions = document.createElement("div");
    actions.className="actions";

    const add = document.createElement("button");
    add.className="add";
    add.textContent="Dodaj u korpu";
    add.onclick = ()=> { addToCart(p.id,1); popConfetti(); rotateEdu(); };

    const details = document.createElement("button");
    details.className="details";
    details.textContent="Brzi pregled";
    details.onclick = ()=> openModal(p.id);

    actions.appendChild(add);
    actions.appendChild(details);

    c.appendChild(row);
    c.appendChild(desc);
    c.appendChild(price);
    c.appendChild(actions);

    card.appendChild(img);
    card.appendChild(c);
    grid.appendChild(card);
  });
}

function toggleWish(id){
  if(state.wish[id]) delete state.wish[id];
  else state.wish[id] = true;
  save();
  renderGrid();
}

function addToCart(id, delta){
  state.cart[id] = (state.cart[id]||0) + delta;
  if(state.cart[id] <= 0) delete state.cart[id];
  save();
  renderCart();
}
function removeFromCart(id){
  delete state.cart[id];
  save();
  renderCart();
}

function renderCart(){
  const box = document.getElementById("cartItems");
  box.innerHTML = "";
  const entries = Object.entries(state.cart);

  let total = 0;

  if(!entries.length){
    const empty = document.createElement("div");
    empty.style.padding="14px";
    empty.style.border="1px solid rgba(255,255,255,.14)";
    empty.style.borderRadius="18px";
    empty.style.background="rgba(255,255,255,.04)";
    empty.style.color="rgba(243,245,255,.88)";
    empty.style.fontWeight="950";
    empty.innerHTML = "Korpa je prazna. Dodaj proizvode i pošalji porudžbinu.";
    box.appendChild(empty);
    document.getElementById("total").textContent = fmt.format(0);
    return;
  }

  entries.forEach(([id,qty])=>{
    const p = PRODUCTS.find(x=>x.id===id);
    if(!p) return;
    total += p.price * qty;

    const it = document.createElement("div");
    it.className="item";

    const mini = document.createElement("div");
    mini.className="mini";
    if(p.img){
      const im = document.createElement("img");
      im.src = p.img; im.alt = p.name;
      mini.appendChild(im);
    } else {
      mini.textContent="IMG";
    }

    const mid = document.createElement("div");
    const t = document.createElement("div");
    t.className="ititle";
    t.textContent=p.name;

    const pr = document.createElement("div");
    pr.className="iprice";
    pr.textContent = `${fmt.format(p.price)} • x${qty}`;

    mid.appendChild(t);
    mid.appendChild(pr);

    const q = document.createElement("div");
    q.className="qty";

    const minus = document.createElement("button");
    minus.className="qbtn";
    minus.textContent="–";
    minus.onclick=()=>addToCart(id,-1);

    const plus = document.createElement("button");
    plus.className="qbtn";
    plus.textContent="+";
    plus.onclick=()=>addToCart(id,+1);

    const del = document.createElement("button");
    del.className="qbtn";
    del.textContent="×";
    del.onclick=()=>removeFromCart(id);

    q.appendChild(minus);
    q.appendChild(plus);
    q.appendChild(del);

    it.appendChild(mini);
    it.appendChild(mid);
    it.appendChild(q);

    box.appendChild(it);
  });

  document.getElementById("total").textContent = fmt.format(total);
}

function toggleCart(open){
  const d = document.getElementById("drawer");
  const b = document.getElementById("backdrop");
  if(open){
    b.style.display="block";
    d.classList.add("open");
  } else {
    b.style.display="none";
    d.classList.remove("open");
  }
}

function checkout(){
  const entries = Object.entries(state.cart);
  if(!entries.length){ alert("Korpa je prazna."); return; }

  let total = 0;
  let msg = `Porudžbina (${encodeURIComponent(SHOP_NAME)})%0A%0A`;
  entries.forEach(([id,qty])=>{
    const p = PRODUCTS.find(x=>x.id===id);
    if(!p) return;
    total += p.price*qty;
    msg += `${encodeURIComponent(p.name)} x${qty} — ${encodeURIComponent(fmt.format(p.price))}%0A`;
  });
  msg += `%0AUkupno: ${encodeURIComponent(fmt.format(total))}%0A`;
  msg += `%0AIME I ADRESA: (upišite ovde)`;

  const url = `viber://forward?text=${msg}`;
  window.open(url, "_blank");
}

function openModal(id){
  const p = PRODUCTS.find(x=>x.id===id);
  if(!p) return;

  const bg = document.getElementById("modalBg");
  const mimg = document.getElementById("mimg");
  mimg.innerHTML = "";

  if(p.img){
    const im = document.createElement("img");
    im.src=p.img; im.alt=p.name;
    mimg.appendChild(im);
  } else {
    const ph = document.createElement("div");
    ph.className="ph";
    ph.textContent="UBACI SLIKU";
    mimg.appendChild(ph);
  }

  document.getElementById("mname").textContent = p.name;
  document.getElementById("mdesc").textContent = p.desc || "";

  const meta = document.getElementById("mmeta");
  meta.innerHTML = "";
  ["Cena: "+fmt.format(p.price), "Valuta: RSD", "Tag: "+(p.tag||"Squishy")].forEach(t=>{
    const el=document.createElement("div");
    el.className="pill"; el.textContent=t;
    meta.appendChild(el);
  });

  document.getElementById("madd").onclick = ()=>{ addToCart(id,1); popConfetti(); toggleCart(true); closeModal(); rotateEdu(); };
  document.getElementById("mwish").onclick = ()=>{ toggleWish(id); rotateEdu(); };

  bg.style.display="flex";
}
function closeModal(){ document.getElementById("modalBg").style.display="none"; }

function popConfetti(){
  const c = document.getElementById("confetti");
  c.innerHTML = "";
  c.style.display = "block";

  const colors = ["#7c5cff","#34d399","#ff6bd6","#ffd166","#4dd3ff"];
  const pieces = 22;

  for(let i=0;i<pieces;i++){
    const p = document.createElement("i");
    p.style.left = (Math.random()*100)+"vw";
    p.style.top = (-20 - Math.random()*80)+"px";
    const size = 8 + Math.random()*8;
    p.style.width = size+"px";
    p.style.height = (size+4)+"px";
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    p.style.animationDuration = (650 + Math.random()*500)+"ms";
    p.style.animationDelay = (Math.random()*120)+"ms";
    c.appendChild(p);
  }
  setTimeout(()=>{ c.style.display="none"; c.innerHTML=""; }, 1100);
}

let eduIdx = 0;
function rotateEdu(){
  eduIdx = (eduIdx + 1) % EDU_TIPS.length;
  document.getElementById("eduNote").textContent = "Tip: " + EDU_TIPS[eduIdx];
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}

function init(){
  document.getElementById("shopName").textContent = SHOP_NAME;
  document.getElementById("shopSub").textContent = SHOP_SUB;
  document.getElementById("year").textContent = new Date().getFullYear();

  document.getElementById("q").addEventListener("input", e=>{ state.q=e.target.value; renderGrid(); });
  document.getElementById("sort").addEventListener("change", e=>{ state.sort=e.target.value; renderGrid(); });
  document.getElementById("scrollShop").onclick = ()=> document.getElementById("grid").scrollIntoView({behavior:"smooth"});

  document.getElementById("openCart").onclick = ()=>{ renderCart(); toggleCart(true); };
  document.getElementById("closeCart").onclick = ()=> toggleCart(false);
  document.getElementById("backdrop").onclick = ()=> toggleCart(false);
  document.getElementById("checkoutBtn").onclick = ()=> checkout();

  document.getElementById("closeModal").onclick = ()=> closeModal();
  document.getElementById("mclose2").onclick = ()=> closeModal();
  document.getElementById("modalBg").addEventListener("click", (e)=>{ if(e.target.id==="modalBg") closeModal(); });

  updateCounts();
  renderFeatured();
  renderGrid();
  renderCart();
}
init();
</script>
</body>
</html>

